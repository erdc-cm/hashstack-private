extends: [base_package]

dependencies:
  # would be nice to have gnu-awk, perl, subversion and bzr as extra dependencies]
  build: [mercurial, git, {{build_with}}]
  run: [mercurial, git, {{build_with}}]

defaults:
  relocatable: false

sources:
- key: tar.gz:fgng7whyvx644fn4a266sjxhwjjk5dre
  url: https://storage.googleapis.com/golang/go1.4.2.src.tar.gz

build_stages:
- name: make-install
  handler: bash
  bash: |
    # setup some target directories and 'install' go
    mkdir -p ${ARTIFACT}/go14
    cp -a * ${ARTIFACT}/go14

    # setup some environment variables that the go build system might expect
    # see http://golang.org/doc/install/source#environment
    export GOROOT=${ARTIFACT}/go14
    export GOROOT_FINAL=${ARTIFACT}/go14
    export GOBIN=${ARTIFACT}/go14/bin

    # 'build' go
    cd ${ARTIFACT}/go14/src
    bash all.bash

    # remove the object files generated by the compilation of go
    find ${ARTIFACT}/go14/src -type f -name '*.[ao]' -delete

    # there isn't a good solution here, the user will need to export
    # GOBIN to their desired location or to ${ARTIFACT}/bin which
    # is the easiest thing to do, or else the developer will need
    # to decide on setting at least the GOPATH AND GOBIN
    #mkdir -p ${ARTIFACT}/bin
    #cp ${ARTIFACT}/go14/bin/* ${ARTIFACT}/bin/

when_build_dependency:
- prepend_path: PATH
  value: '${ARTIFACT}/go14/bin'
